<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Follow Up de Vagas</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:#f8f9fa;min-height:100vh}.header{background:#fff;border-bottom:1px solid #e5e7eb;padding:0 24px;display:flex;justify-content:space-between;align-items:center}.nav{display:flex}.nav-btn{padding:16px 24px;font-size:15px;font-weight:500;background:0 0;border:none;border-bottom:2px solid transparent;cursor:pointer;color:#6b7280}.nav-btn.active{color:#2563eb;border-bottom-color:#2563eb}.header-actions{display:flex;gap:8px;padding:10px 0;align-items:center}.user-info{font-size:12px;color:#6b7280;margin-right:10px}.main{padding:16px}.grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px}.kpi{border-radius:8px;padding:16px;border:1px solid #e5e7eb}.kpi-label{font-size:13px;color:#6b7280;margin-bottom:4px}.kpi-value{font-size:32px;font-weight:700}.kpi-sub{font-size:12px;color:#9ca3af;margin-top:2px}.card{background:#fff;border-radius:8px;border:1px solid #e5e7eb;padding:16px;margin-bottom:16px}.etapas-row{display:flex;gap:3px}.etapa-card{flex:1;text-align:center;padding:6px 2px;background:#f9fafb;border-radius:4px;border:1px solid #e5e7eb}.etapa-name{font-size:9px;color:#6b7280;margin-bottom:2px}.etapa-qty{font-size:14px;font-weight:700;color:#111827}.etapa-ef{font-size:11px;font-weight:600;border-radius:2px;padding:1px 3px}table{width:100%;border-collapse:collapse;font-size:12px}th{padding:8px 4px;text-align:left;font-weight:600;color:#6b7280;border-bottom:2px solid #e5e7eb}th.center{text-align:center}td{padding:10px 4px;border-bottom:1px solid #f3f4f6}td.center{text-align:center}tr:nth-child(even){background:#f9fafb}.badge{padding:3px 8px;border-radius:4px;font-weight:700;font-size:11px}.badge-pill{border-radius:20px;padding:3px 12px;font-weight:500}.blue-bg{background:#eff6ff}.purple-bg{background:#faf5ff}.green-bg{background:#f0fdf4}.red-bg{background:#fef2f2}.yellow-bg{background:#fefce8}.blue{color:#2563eb}.purple{color:#9333ea}.green{color:#16a34a}.red{color:#dc2626}.yellow{color:#ca8a04}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.page-title{font-size:20px;font-weight:700}.btn-group{display:flex;gap:6px}.btn{padding:8px 16px;font-size:13px;font-weight:500;border-radius:5px;border:none;cursor:pointer}.btn-primary{background:#2563eb;color:#fff}.btn-outline{background:#fff;color:#374151;border:1px solid #d1d5db}.btn-success{background:#16a34a;color:#fff}.btn-danger{background:#dc2626;color:#fff}.btn-sm{padding:5px 10px;font-size:12px;border-radius:4px;min-width:65px}.filters{display:grid;grid-template-columns:1fr 170px 170px 170px;gap:12px}input,select{width:100%;padding:8px 12px;font-size:13px;border:1px solid #d1d5db;border-radius:5px;outline:0}.actions{display:flex;justify-content:flex-end;gap:5px;min-width:200px}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50}.modal{background:#fff;border-radius:8px;padding:24px;width:100%;max-width:500px;margin:16px;max-height:90vh;overflow-y:auto}.modal-title{font-size:18px;font-weight:700;margin-bottom:20px}.form-group{margin-bottom:16px}.form-group label{display:block;font-size:13px;font-weight:500;color:#374151;margin-bottom:6px}.hidden{display:none!important}.text-gray{color:#6b7280}.funcoes-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}.funcao-card{background:#fff;border:2px solid #e2e8f0;border-radius:10px;overflow:hidden}.funcao-header{background:linear-gradient(135deg,#1e40af,#3b82f6);color:#fff;padding:12px 16px;font-weight:700;font-size:14px;text-align:center}.funcao-body-grid{display:grid;grid-template-columns:1fr 1fr}.uf-col{padding:12px;border-right:1px solid #e2e8f0;display:flex;flex-direction:column}.uf-col:last-child{border-right:none}.uf-header-box{padding:10px;border-radius:8px;margin-bottom:10px;text-align:center}.uf-header-box.uf-ba{background:#fef3c7;border:1px solid #fcd34d}.uf-header-box.uf-rn{background:#dbeafe;border:1px solid #93c5fd}.uf-nome{font-weight:700;font-size:14px;color:#1e293b}.uf-total-num{font-size:20px;font-weight:700;color:#1e40af;margin-top:2px}.uf-total-num span{font-size:12px;font-weight:400;color:#64748b}.etapas-lista{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;flex:1}.etapa-item{display:flex;align-items:center;gap:8px;padding:5px 8px;background:#f8fafc;border-radius:6px;border:1px solid #e2e8f0;cursor:pointer}.etapa-item:hover{background:#e0e7ff;border-color:#818cf8}.etapa-item-qty{background:#3b82f6;color:#fff;font-weight:700;font-size:13px;min-width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center}.etapa-item-name{font-size:12px;color:#334155;font-weight:500;flex:1}.etapa-aprovado{background:#f0fdf4;border-color:#86efac}.etapa-aprovado .etapa-item-qty{background:#16a34a}.etapa-aprovado .etapa-item-name{color:#16a34a;font-weight:600}.uf-resumo-box{display:flex;justify-content:space-around;padding:10px;background:#f1f5f9;border-radius:8px;margin-top:auto}.resumo-num{display:block;font-weight:700;font-size:20px}.resumo-label{font-size:11px;color:#64748b}.resumo-processo .resumo-num{color:#f59e0b}.resumo-aprovado .resumo-num{color:#16a34a}.ef-section{margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb}.ef-section:last-child{border-bottom:none}.ef-title{font-weight:700;font-size:14px;color:#2563eb;margin-bottom:10px}.login-container{position:fixed;top:0;left:0;right:0;bottom:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e40af,#3b82f6);z-index:9999}.login-box{background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);width:100%;max-width:400px}.login-title{font-size:24px;font-weight:700;color:#1e293b;margin-bottom:8px;text-align:center}.login-subtitle{font-size:14px;color:#64748b;margin-bottom:24px;text-align:center}.login-error{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:10px;border-radius:6px;margin-bottom:16px;font-size:13px}.loading{text-align:center;padding:40px;color:#6b7280}.spinner{border:3px solid #e5e7eb;border-top:3px solid #2563eb;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 16px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>
<div id="login-screen" class="login-container"><div class="login-box"><h1 class="login-title">üéØ Follow Up de Vagas</h1><p class="login-subtitle">Entre com suas credenciais</p><div id="login-error" class="login-error hidden"></div><div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="seu@email.com"></div><div class="form-group"><label>Senha</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><button class="btn btn-primary" style="width:100%;padding:12px;font-size:15px" id="btnLogin">Entrar</button></div></div>
<div id="app-screen" class="hidden"><header class="header"><nav class="nav"><button class="nav-btn active" id="nav-dashboard">Dashboard</button><button class="nav-btn" id="nav-vagas">Vagas</button><button class="nav-btn" id="nav-candidatos">Candidatos</button></nav><div class="header-actions"><span class="user-info" id="user-email"></span><button class="btn btn-outline btn-sm" id="btnLogout">Sair</button></div></header><main class="main"><div id="loading" class="loading"><div class="spinner"></div>Carregando dados...</div><div id="dashboard" class="hidden"></div><div id="vagas" class="hidden"></div><div id="candidatos" class="hidden"></div></main></div>
<div id="modal" class="modal-overlay hidden"><div class="modal"><h2 class="modal-title" id="modal-title"></h2><div id="modal-content"></div></div></div>
<script>
(function(){
const SUPABASE_URL='https://jocusweupkmzaqxkczjy.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvY3Vzd2V1cGttemFxeGtjemp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NDM3NDAsImV4cCI6MjA4NTIxOTc0MH0.wlSR8teEYnOVornAC0NU0CWHlg_1wrLlXSjvtWo47tU';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const ETAPAS=['Abertura da Vaga','Capta√ß√£o','Triagem','Checagem Dados','Entrevista RH','Teste Pr√°tico','Proposta Benel','ASO','Docs pasta DP','Enviar para DP','Apto para Integra√ß√£o','Subir Doc. Portal','PT Cliente','Integra√ß√£o Cliente','Aprovado no Portal'];
const ESTADOS=['BA','RN'];
let vagas=[],candidatos=[],currentTab='dashboard',filterSearch='',filterEtapa='todos',filterEstado='todos',filterFuncao='todos',sortDir='asc';

async function init(){
  const{data:{session}}=await sb.auth.getSession();
  if(session)showApp(session.user);
}

document.getElementById('btnLogin').onclick=async function(){
  const email=document.getElementById('login-email').value;
  const pwd=document.getElementById('login-password').value;
  if(!email||!pwd){showErr('Preencha email e senha');return;}
  const{data,error}=await sb.auth.signInWithPassword({email,password:pwd});
  if(error){showErr('Email ou senha incorretos');return;}
  showApp(data.user);
};

document.getElementById('btnLogout').onclick=async function(){
  await sb.auth.signOut();
  document.getElementById('app-screen').classList.add('hidden');
  document.getElementById('login-screen').classList.remove('hidden');
};

document.getElementById('login-password').onkeypress=function(e){if(e.key==='Enter')document.getElementById('btnLogin').click();};

function showErr(m){const e=document.getElementById('login-error');e.textContent=m;e.classList.remove('hidden');}

async function showApp(user){
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app-screen').classList.remove('hidden');
  document.getElementById('user-email').textContent=user.email;
  document.getElementById('loading').classList.remove('hidden');
  await loadData();
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  render();
}

async function loadData(){
  const{data:v}=await sb.from('vagas').select('*').order('id');
  const{data:c}=await sb.from('candidatos').select('*').order('id');
  vagas=v||[];
  candidatos=(c||[]).map(x=>({...x,positionId:x.position_id,currentStage:x.current_stage,checklist:x.checklist||Array(15).fill(false)}));
}

function isOk(c){return c.currentStage===14;}

document.getElementById('nav-dashboard').onclick=function(){showTab('dashboard');};
document.getElementById('nav-vagas').onclick=function(){showTab('vagas');};
document.getElementById('nav-candidatos').onclick=function(){showTab('candidatos');};

function showTab(t){
  currentTab=t;
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('nav-'+t).classList.add('active');
  ['dashboard','vagas','candidatos'].forEach(x=>document.getElementById(x).classList.add('hidden'));
  document.getElementById(t).classList.remove('hidden');
  render();
}

function render(){
  if(currentTab==='dashboard')renderDash();
  else if(currentTab==='vagas')renderVagas();
  else renderCands();
}

function renderDash(){
  const tp=vagas.reduce((s,v)=>s+v.quantity,0),tc=candidatos.length;
  const okT=candidatos.filter(isOk).length,pT=tp-okT;
  const cBA=candidatos.filter(c=>vagas.find(v=>v.id===c.positionId)?.state==='BA');
  const cRN=candidatos.filter(c=>vagas.find(v=>v.id===c.positionId)?.state==='RN');
  const mBA=vagas.filter(v=>v.state==='BA').reduce((s,v)=>s+v.quantity,0);
  const mRN=vagas.filter(v=>v.state==='RN').reduce((s,v)=>s+v.quantity,0);
  const oBA=cBA.filter(isOk).length,oRN=cRN.filter(isOk).length;
  const pBA=mBA-oBA,pRN=mRN-oRN;
  const eg=tp>0?Math.round(okT/tp*100):0;
  const cpe=ETAPAS.map((_,i)=>candidatos.filter(c=>c.currentStage===i).length);
  const epe=ETAPAS.map((_,i)=>tp>0?Math.round(cpe[i]/tp*100):0);
  let h=`<div class="grid-5"><div class="kpi blue-bg"><div class="kpi-label">Vagas Planejadas</div><div class="kpi-value blue">${tp}</div><div class="kpi-sub">${vagas.length} tipos</div></div><div class="kpi purple-bg"><div class="kpi-label">Total Candidatos</div><div class="kpi-value purple">${tc}</div><div class="kpi-sub">BA:${cBA.length}|RN:${cRN.length}</div></div><div class="kpi green-bg"><div class="kpi-label">Conclu√≠dos</div><div class="kpi-value green">${okT}</div><div class="kpi-sub">BA:${oBA}|RN:${oRN}</div></div><div class="kpi ${pT>0?'yellow-bg':'green-bg'}"><div class="kpi-label">Faltam p/ Meta</div><div class="kpi-value ${pT>0?'yellow':'green'}">${pT}</div><div class="kpi-sub">BA:${pBA}|RN:${pRN}</div></div><div class="kpi ${eg>=80?'green-bg':eg>=50?'yellow-bg':'red-bg'}"><div class="kpi-label">Efici√™ncia</div><div class="kpi-value ${eg>=80?'green':eg>=50?'yellow':'red'}">${eg}%</div></div></div>`;
  h+=`<div class="card"><div class="ef-section"><div class="ef-title">üìä Vis√£o Geral</div><div class="etapas-row">${ETAPAS.map((et,i)=>`<div class="etapa-card"><div class="etapa-name">${et}</div><div class="etapa-qty">${cpe[i]||'-'}</div><div class="etapa-ef" style="background:${cpe[i]>0?(epe[i]>=50?'#dcfce7':'#fef9c3'):'transparent'};color:${cpe[i]>0?(epe[i]>=50?'#16a34a':'#ca8a04'):'#9ca3af'}">${epe[i]}%</div></div>`).join('')}</div></div>`;
  const funcs=[...new Set(vagas.map(v=>v.title))];
  h+=`<div class="ef-section"><div class="ef-title">üéØ Follow Up por Fun√ß√£o</div><div class="funcoes-grid">`;
  funcs.forEach(func=>{
    const ds=[];
    ['BA','RN'].forEach(est=>{
      const vg=vagas.find(v=>v.title===func&&v.state===est);
      if(!vg)return;
      const cs=candidatos.filter(c=>c.positionId===vg.id);
      const pe=ETAPAS.map((_,i)=>({i,n:ETAPAS[i],q:cs.filter(c=>c.currentStage===i).length})).filter(e=>e.q>0).sort((a,b)=>a.i-b.i);
      ds.push({est,vg,pe,t:cs.length,ok:cs.filter(isOk).length,m:vg.quantity});
    });
    if(!ds.length)return;
    const mxH=Math.max(...ds.map(d=>d.pe.length));
    h+=`<div class="funcao-card"><div class="funcao-header">${func}</div><div class="funcao-body-grid">`;
    ds.forEach(d=>{
      const f=d.m-d.ok;
      h+=`<div class="uf-col"><div class="uf-header-box uf-${d.est.toLowerCase()}"><div class="uf-nome">${d.est==='BA'?'Bahia':'RN'}</div><div class="uf-total-num">${d.t} <span>cand.</span></div><div style="margin-top:4px;font-size:12px;color:#1e40af;font-weight:600">Meta:${d.m}</div><div style="margin-top:4px;font-size:12px;font-weight:700;color:${f>0?'#dc2626':'#16a34a'}">${f>0?'Faltam:'+f:'‚úì Atingida!'}</div></div><div class="etapas-lista" style="min-height:${mxH*38}px">`;
      d.pe.forEach(e=>{h+=`<div class="etapa-item ${e.i===14?'etapa-aprovado':''}" data-vaga="${d.vg.id}" data-etapa="${e.i}"><span class="etapa-item-qty">${e.q}</span><span class="etapa-item-name">${e.n}</span></div>`;});
      h+=`</div><div class="uf-resumo-box"><div class="resumo-processo"><span class="resumo-num">${d.t-d.ok}</span><span class="resumo-label">‚è≥ processo</span></div><div class="resumo-aprovado"><span class="resumo-num">${d.ok}</span><span class="resumo-label">‚úÖ ok</span></div></div></div>`;
    });
    h+=`</div></div>`;
  });
  h+=`</div></div></div>`;
  document.getElementById('dashboard').innerHTML=h;
  document.querySelectorAll('.etapa-item').forEach(el=>{el.onclick=function(){showCandEtapa(+this.dataset.vaga,+this.dataset.etapa);};});
}

function showCandEtapa(vid,eidx){
  const vg=vagas.find(v=>v.id===vid);
  const cs=candidatos.filter(c=>c.positionId===vid&&c.currentStage===eidx);
  document.getElementById('modal-title').textContent=ETAPAS[eidx];
  document.getElementById('modal-content').innerHTML=`<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-bottom:16px"><div style="font-size:13px;color:#64748b">Vaga:<strong style="color:#1e40af">${vg.title}</strong>-${vg.state}</div><div style="font-size:13px;color:#64748b">Total:<strong style="color:#16a34a">${cs.length}</strong></div></div><div style="max-height:350px;overflow-y:auto">${cs.length?`<table><thead><tr><th>#</th><th>Nome</th><th class="center">A√ß√£o</th></tr></thead><tbody>${cs.map((c,i)=>`<tr><td>${i+1}</td><td>${c.name}</td><td class="center"><button class="btn btn-primary btn-sm" data-id="${c.id}">Checklist</button></td></tr>`).join('')}</tbody></table>`:'<p style="text-align:center;color:#64748b;padding:20px">Nenhum</p>'}</div><div class="btn-group" style="margin-top:16px"><button class="btn btn-outline" style="flex:1" id="closeModalBtn">Fechar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('closeModalBtn').onclick=closeModal;
  document.querySelectorAll('#modal-content .btn-primary').forEach(b=>{b.onclick=function(){closeModal();setTimeout(()=>openCheck(+this.dataset.id),100);};});
}

function openCheck(id){
  const c=candidatos.find(x=>x.id===id),v=vagas.find(x=>x.id===c.positionId);
  if(!c.checklist)c.checklist=Array(15).fill(false);
  const ok=isOk(c);
  document.getElementById('modal-title').textContent='Checklist';
  let h=`<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-bottom:16px"><div style="font-size:14px;font-weight:600">${c.name}</div><div style="font-size:12px;color:#64748b">${v?.title||'N/A'}-${v?.state||''}</div><div style="margin-top:8px">${ok?'<span style="background:#dcfce7;color:#16a34a;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600">‚úÖ CONCLU√çDO</span>':'<span style="background:#fef3c7;color:#92400e;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600">‚è≥ PROCESSO</span>'}</div></div><div style="max-height:320px;overflow-y:auto">`;
  ETAPAS.forEach((et,i)=>{const ch=c.checklist[i];h+=`<label style="display:flex;align-items:center;gap:10px;padding:8px 10px;margin-bottom:4px;background:${ch?'#f0fdf4':'#fff'};border:1px solid ${ch?'#86efac':'#e2e8f0'};border-radius:6px;cursor:pointer"><input type="checkbox" ${ch?'checked':''} data-idx="${i}" style="width:18px;height:18px"><span style="flex:1;font-size:13px;color:${ch?'#16a34a':'#334155'};font-weight:${ch?'600':'400'}">${i+1}.${et}</span>${ch?'<span style="color:#16a34a">‚úì</span>':''}</label>`;});
  h+=`</div><div class="btn-group" style="margin-top:16px"><button class="btn btn-success" style="flex:1" id="markAll">‚úì Todas</button><button class="btn btn-outline" style="flex:1" id="clearAll">‚úó Limpar</button></div><div class="btn-group" style="margin-top:8px"><button class="btn btn-primary" style="flex:1" id="closeCheck">Fechar</button></div>`;
  document.getElementById('modal-content').innerHTML=h;
  document.getElementById('modal').classList.remove('hidden');
  document.querySelectorAll('#modal-content input[type=checkbox]').forEach(cb=>{cb.onchange=async function(){await toggleEt(id,+this.dataset.idx);};});
  document.getElementById('markAll').onclick=async function(){await markAll(id);};
  document.getElementById('clearAll').onclick=async function(){await clearAll(id);};
  document.getElementById('closeCheck').onclick=function(){closeModal();render();};
}

async function toggleEt(id,idx){const c=candidatos.find(x=>x.id===id);c.checklist[idx]=!c.checklist[idx];let l=-1;for(let i=14;i>=0;i--)if(c.checklist[i]){l=i;break;}c.currentStage=l>=0?l:0;await sb.from('candidatos').update({checklist:c.checklist,current_stage:c.currentStage}).eq('id',id);openCheck(id);}
async function markAll(id){const c=candidatos.find(x=>x.id===id);c.checklist=Array(15).fill(true);c.currentStage=14;await sb.from('candidatos').update({checklist:c.checklist,current_stage:c.currentStage}).eq('id',id);openCheck(id);}
async function clearAll(id){const c=candidatos.find(x=>x.id===id);c.checklist=Array(15).fill(false);c.currentStage=0;await sb.from('candidatos').update({checklist:c.checklist,current_stage:c.currentStage}).eq('id',id);openCheck(id);}

function renderVagas(){
  let h=`<div class="page-header"><h1 class="page-title">Vagas</h1><button class="btn btn-primary" id="newVaga">+ Nova</button></div><div class="card" style="padding:0"><table><thead><tr><th>Vaga</th><th>Estado</th><th class="center">Meta</th><th class="center">Cands</th><th class="center">A√ß√µes</th></tr></thead><tbody>`;
  vagas.forEach(v=>{h+=`<tr><td>${v.title}</td><td>${v.state}</td><td class="center"><span class="badge-pill" style="background:#dbeafe;color:#1d4ed8">${v.quantity}</span></td><td class="center"><span class="badge-pill" style="background:#f3e8ff;color:#7c3aed">${candidatos.filter(c=>c.positionId===v.id).length}</span></td><td class="center"><button class="btn btn-outline btn-sm" data-edit="${v.id}">Editar</button> <button class="btn btn-danger btn-sm" data-del="${v.id}">Del</button></td></tr>`;});
  h+=`</tbody></table></div>`;
  document.getElementById('vagas').innerHTML=h;
  document.getElementById('newVaga').onclick=function(){openVagaModal();};
  document.querySelectorAll('[data-edit]').forEach(b=>{b.onclick=function(){openVagaModal(+this.dataset.edit);};});
  document.querySelectorAll('[data-del]').forEach(b=>{b.onclick=async function(){if(!confirm('Deletar?'))return;const id=+this.dataset.del;await sb.from('candidatos').delete().eq('position_id',id);await sb.from('vagas').delete().eq('id',id);vagas=vagas.filter(v=>v.id!==id);candidatos=candidatos.filter(c=>c.positionId!==id);render();};});
}

function openVagaModal(id){
  const v=id?vagas.find(x=>x.id===id):null;
  document.getElementById('modal-title').textContent=v?'Editar Vaga':'Nova Vaga';
  document.getElementById('modal-content').innerHTML=`<div class="form-group"><label>Nome</label><input type="text" id="vTitle" value="${v?.title||''}"></div><div class="form-group"><label>Estado</label><select id="vState">${ESTADOS.map(e=>`<option value="${e}" ${v?.state===e?'selected':''}>${e}</option>`).join('')}</select></div><div class="form-group"><label>Meta</label><input type="number" id="vQty" value="${v?.quantity||1}"></div><div class="btn-group"><button class="btn btn-primary" style="flex:1" id="saveVaga">Salvar</button><button class="btn btn-outline" style="flex:1" id="cancelVaga">Cancelar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('cancelVaga').onclick=closeModal;
  document.getElementById('saveVaga').onclick=async function(){
    const t=document.getElementById('vTitle').value.trim(),s=document.getElementById('vState').value,q=parseInt(document.getElementById('vQty').value)||1;
    if(!t){alert('Preencha');return;}
    if(id){await sb.from('vagas').update({title:t,state:s,quantity:q}).eq('id',id);const vv=vagas.find(x=>x.id===id);vv.title=t;vv.state=s;vv.quantity=q;}
    else{const{data}=await sb.from('vagas').insert({title:t,state:s,quantity:q}).select();if(data)vagas.push(data[0]);}
    closeModal();render();
  };
}

function renderCands(){
  const funcs=[...new Set(vagas.map(v=>v.title))];
  let h=`<div class="page-header"><h1 class="page-title">Candidatos</h1><div class="btn-group"><button class="btn btn-success" id="expExcel">üìä Excel</button><button class="btn btn-primary" id="newCand">+ Novo</button></div></div><div class="card"><div class="filters"><input type="text" placeholder="Buscar..." id="fSearch" value="${filterSearch}"><select id="fEtapa"><option value="todos">Todas Etapas</option>${ETAPAS.map((e,i)=>`<option value="${i}" ${filterEtapa==i?'selected':''}>${i+1}.${e}</option>`).join('')}</select><select id="fEstado"><option value="todos">Todos Estados</option>${ESTADOS.map(e=>`<option value="${e}" ${filterEstado===e?'selected':''}>${e}</option>`).join('')}</select><select id="fFuncao"><option value="todos">Todas Fun√ß√µes</option>${funcs.map(f=>`<option value="${f}" ${filterFuncao===f?'selected':''}>${f}</option>`).join('')}</select></div></div><div class="card" style="padding:0"><table><thead><tr><th id="sortName" style="cursor:pointer">Nome</th><th>Vaga</th><th>Etapa</th><th class="center">A√ß√µes</th></tr></thead><tbody id="tbCand"></tbody></table></div>`;
  document.getElementById('candidatos').innerHTML=h;
  document.getElementById('fSearch').oninput=function(){filterSearch=this.value;renderTbl();};
  document.getElementById('fEtapa').onchange=function(){filterEtapa=this.value;renderTbl();};
  document.getElementById('fEstado').onchange=function(){filterEstado=this.value;renderTbl();};
  document.getElementById('fFuncao').onchange=function(){filterFuncao=this.value;renderTbl();};
  document.getElementById('sortName').onclick=function(){sortDir=sortDir==='asc'?'desc':'asc';renderTbl();};
  document.getElementById('newCand').onclick=openCandModal;
  document.getElementById('expExcel').onclick=expExcel;
  renderTbl();
}

function renderTbl(){
  let f=candidatos.filter(c=>{const v=vagas.find(x=>x.id===c.positionId);return c.name.toLowerCase().includes(filterSearch.toLowerCase())&&(filterEtapa==='todos'||c.currentStage===parseInt(filterEtapa))&&(filterEstado==='todos'||(v&&v.state===filterEstado))&&(filterFuncao==='todos'||(v&&v.title===filterFuncao));});
  f.sort((a,b)=>sortDir==='asc'?a.name.localeCompare(b.name):b.name.localeCompare(a.name));
  let h='';
  f.slice(0,200).forEach(c=>{const v=vagas.find(x=>x.id===c.positionId),ok=isOk(c),m=c.checklist?c.checklist.filter(x=>x).length:0;h+=`<tr style="${ok?'background:#f0fdf4':''}"><td>${c.name}${ok?' <span style="background:#dcfce7;color:#16a34a;padding:2px 6px;border-radius:10px;font-size:10px">‚úì</span>':''}</td><td class="text-gray">${v?.title||'-'}</td><td><span class="badge" style="background:#dbeafe;color:#1d4ed8">${c.currentStage+1}.${ETAPAS[c.currentStage]}</span> <span style="color:#9ca3af;font-size:11px">(${m}/15)</span></td><td><div class="actions"><button class="btn btn-primary btn-sm" data-check="${c.id}">Check</button><button class="btn btn-danger btn-sm" data-delc="${c.id}">Del</button></div></td></tr>`;});
  document.getElementById('tbCand').innerHTML=h;
  document.querySelectorAll('[data-check]').forEach(b=>{b.onclick=function(){openCheck(+this.dataset.check);};});
  document.querySelectorAll('[data-delc]').forEach(b=>{b.onclick=async function(){if(!confirm('Deletar?'))return;const id=+this.dataset.delc;await sb.from('candidatos').delete().eq('id',id);candidatos=candidatos.filter(c=>c.id!==id);renderTbl();};});
}

function openCandModal(){
  document.getElementById('modal-title').textContent='Novo Candidato';
  document.getElementById('modal-content').innerHTML=`<div class="form-group"><label>Nome</label><input type="text" id="cName"></div><div class="form-group"><label>Vaga</label><select id="cVaga"><option value="">Selecione</option>${vagas.map(v=>`<option value="${v.id}">${v.title}-${v.state}</option>`).join('')}</select></div><div class="form-group"><label>Etapa</label><select id="cEtapa">${ETAPAS.map((e,i)=>`<option value="${i}">${i+1}.${e}</option>`).join('')}</select></div><div class="btn-group"><button class="btn btn-primary" style="flex:1" id="saveCand">Salvar</button><button class="btn btn-outline" style="flex:1" id="cancelCand">Cancelar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('cancelCand').onclick=closeModal;
  document.getElementById('saveCand').onclick=async function(){
    const n=document.getElementById('cName').value.trim(),p=parseInt(document.getElementById('cVaga').value),s=parseInt(document.getElementById('cEtapa').value)||0;
    if(!n){alert('Preencha');return;}if(!p){alert('Selecione vaga');return;}
    const ch=Array(15).fill(false);for(let i=0;i<=s;i++)ch[i]=true;
    const{data}=await sb.from('candidatos').insert({name:n,position_id:p,current_stage:s,status:'in_process',checklist:ch}).select();
    if(data)candidatos.push({...data[0],positionId:data[0].position_id,currentStage:data[0].current_stage});
    closeModal();render();
  };
}

function expExcel(){
  let d=candidatos.map(c=>{const v=vagas.find(x=>x.id===c.positionId);return{n:c.name,f:v?.title||'N/A',e:ETAPAS[c.currentStage]||'N/A',s:v?.state==='BA'?'Bahia':'RN',st:isOk(c)?'Conclu√≠do':'Processo'};});
  d=d.filter(x=>x.n.toLowerCase().includes(filterSearch.toLowerCase())&&(filterEstado==='todos'||(filterEstado==='BA'&&x.s==='Bahia')||(filterEstado==='RN'&&x.s==='RN'))&&(filterFuncao==='todos'||x.f===filterFuncao));
  d.sort((a,b)=>a.n.localeCompare(b.n));
  let csv='\uFEFF'+'Nome;Fun√ß√£o;Etapa;Estado;Status\n';
  d.forEach(x=>{csv+=`${x.n};${x.f};${x.e};${x.s};${x.st}\n`;});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=`candidatos_${new Date().toISOString().slice(0,10)}.csv`;a.click();
}

function closeModal(){document.getElementById('modal').classList.add('hidden');}
document.getElementById('modal').onclick=function(e){if(e.target===this)closeModal();};

init();
})();
</script>
</body>
</html>
