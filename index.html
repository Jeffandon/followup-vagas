<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Follow Up de Vagas</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:#f8f9fa;min-height:100vh}.header{background:#fff;border-bottom:1px solid #e5e7eb;padding:0 24px;display:flex;justify-content:space-between;align-items:center}.nav{display:flex}.nav-btn{padding:16px 24px;font-size:15px;font-weight:500;background:0 0;border:none;border-bottom:2px solid transparent;cursor:pointer;color:#6b7280}.nav-btn.active{color:#2563eb;border-bottom-color:#2563eb}.header-actions{display:flex;gap:8px;padding:10px 0;align-items:center}.user-info{font-size:12px;color:#6b7280;margin-right:10px}.main{padding:16px}.grid-5{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px}.kpi{border-radius:8px;padding:16px;border:1px solid #e5e7eb}.kpi-label{font-size:13px;color:#6b7280;margin-bottom:4px}.kpi-value{font-size:32px;font-weight:700}.kpi-sub{font-size:12px;color:#9ca3af;margin-top:2px}.card{background:#fff;border-radius:8px;border:1px solid #e5e7eb;padding:16px;margin-bottom:16px}.etapas-row{display:flex;gap:3px}.etapa-card{flex:1;text-align:center;padding:6px 2px;background:#f9fafb;border-radius:4px;border:1px solid #e5e7eb}.etapa-name{font-size:9px;color:#6b7280;margin-bottom:2px}.etapa-qty{font-size:14px;font-weight:700;color:#111827}.etapa-ef{font-size:11px;font-weight:600;border-radius:2px;padding:1px 3px}table{width:100%;border-collapse:collapse;font-size:12px}th{padding:8px 4px;text-align:left;font-weight:600;color:#6b7280;border-bottom:2px solid #e5e7eb}th.center{text-align:center}td{padding:10px 4px;border-bottom:1px solid #f3f4f6}td.center{text-align:center}tr:nth-child(even){background:#f9fafb}.badge{padding:3px 8px;border-radius:4px;font-weight:700;font-size:11px}.badge-pill{border-radius:20px;padding:3px 12px;font-weight:500}.blue-bg{background:#eff6ff}.purple-bg{background:#faf5ff}.green-bg{background:#f0fdf4}.red-bg{background:#fef2f2}.yellow-bg{background:#fefce8}.blue{color:#2563eb}.purple{color:#9333ea}.green{color:#16a34a}.red{color:#dc2626}.yellow{color:#ca8a04}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.page-title{font-size:20px;font-weight:700}.btn-group{display:flex;gap:6px}.btn{padding:8px 16px;font-size:13px;font-weight:500;border-radius:5px;border:none;cursor:pointer}.btn-primary{background:#2563eb;color:#fff}.btn-outline{background:#fff;color:#374151;border:1px solid #d1d5db}.btn-success{background:#16a34a;color:#fff}.btn-danger{background:#dc2626;color:#fff}.btn-wehandle{background:#7c3aed;color:#fff}.btn-sm{padding:5px 10px;font-size:12px;border-radius:4px;min-width:65px}.filters{display:grid;grid-template-columns:1fr 150px 150px 150px 150px;gap:12px}input,select{width:100%;padding:8px 12px;font-size:13px;border:1px solid #d1d5db;border-radius:5px;outline:0}.actions{display:flex;justify-content:flex-end;gap:5px;min-width:200px}.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:50}.modal{background:#fff;border-radius:8px;padding:24px;width:100%;max-width:560px;margin:16px;max-height:90vh;overflow-y:auto}.modal-title{font-size:18px;font-weight:700;margin-bottom:20px}.form-group{margin-bottom:14px}.form-group label{display:block;font-size:13px;font-weight:500;color:#374151;margin-bottom:5px}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}.form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}.section-divider{font-size:12px;font-weight:700;color:#7c3aed;text-transform:uppercase;letter-spacing:1px;margin:16px 0 10px;padding-bottom:6px;border-bottom:2px solid #ede9fe}.required::after{content:" *";color:#dc2626}.info-box{background:#eff6ff;border:1px solid #bfdbfe;border-radius:6px;padding:10px;margin-bottom:16px;font-size:12px;color:#1e40af}.hidden{display:none!important}.text-gray{color:#6b7280}.funcoes-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;align-items:stretch}.funcao-card{background:#fff;border:2px solid #e2e8f0;border-radius:10px;overflow:hidden;display:flex;flex-direction:column}.funcao-header{background:linear-gradient(135deg,#1e40af,#3b82f6);color:#fff;padding:12px 16px;font-weight:700;font-size:14px;text-align:center}.funcao-body-grid{display:flex;flex:1}.uf-col{flex:1;padding:12px;border-right:1px solid #e2e8f0;display:flex;flex-direction:column}.uf-col:last-child{border-right:none}.uf-header-box{padding:10px;border-radius:8px;margin-bottom:10px;text-align:center}.uf-header-box.uf-ba{background:#fef3c7;border:1px solid #fcd34d}.uf-header-box.uf-rn{background:#dbeafe;border:1px solid #93c5fd}.uf-nome{font-weight:700;font-size:14px;color:#1e293b}.uf-total-num{font-size:20px;font-weight:700;color:#1e40af;margin-top:2px}.uf-total-num span{font-size:12px;font-weight:400;color:#64748b}.etapas-lista{flex:1;display:flex;flex-direction:column;gap:5px;margin-bottom:10px}.etapa-item{display:flex;align-items:center;gap:8px;padding:5px 8px;background:#f8fafc;border-radius:6px;border:1px solid #e2e8f0;cursor:pointer}.etapa-item:hover{background:#e0e7ff;border-color:#818cf8}.etapa-item-qty{background:#3b82f6;color:#fff;font-weight:700;font-size:13px;min-width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center}.etapa-item-name{font-size:12px;color:#334155;font-weight:500;flex:1}.etapa-aprovado{background:#f0fdf4;border-color:#86efac}.etapa-aprovado .etapa-item-qty{background:#16a34a}.etapa-aprovado .etapa-item-name{color:#16a34a;font-weight:600}.uf-resumo-box{display:flex;justify-content:space-around;padding:10px;background:#f1f5f9;border-radius:8px;margin-top:auto}.resumo-num{display:block;font-weight:700;font-size:20px}.resumo-label{font-size:11px;color:#64748b}.resumo-processo .resumo-num{color:#f59e0b}.resumo-aprovado .resumo-num{color:#16a34a}.ef-section{margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #e5e7eb}.ef-section:last-child{border-bottom:none}.ef-title{font-weight:700;font-size:14px;color:#2563eb;margin-bottom:10px}.login-container{position:fixed;top:0;left:0;right:0;bottom:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e40af,#3b82f6);z-index:9999}.login-box{background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,.2);width:100%;max-width:400px}.login-title{font-size:24px;font-weight:700;color:#1e293b;margin-bottom:8px;text-align:center}.login-subtitle{font-size:14px;color:#64748b;margin-bottom:24px;text-align:center}.login-error{background:#fef2f2;border:1px solid #fecaca;color:#dc2626;padding:10px;border-radius:6px;margin-bottom:16px;font-size:13px}.loading{text-align:center;padding:40px;color:#6b7280}.spinner{border:3px solid #e5e7eb;border-top:3px solid #2563eb;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto 16px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.contrato-filter{background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap}.contrato-filter label{font-weight:600;color:#374151;white-space:nowrap}.contrato-badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}
</style>
</head>
<body>
<div id="login-screen" class="login-container"><div class="login-box"><h1 class="login-title">üéØ Follow Up de Vagas</h1><p class="login-subtitle">Entre com suas credenciais</p><div id="login-error" class="login-error hidden"></div><div class="form-group"><label>Email</label><input type="email" id="login-email" placeholder="seu@email.com"></div><div class="form-group"><label>Senha</label><input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div><button class="btn btn-primary" style="width:100%;padding:12px;font-size:15px" id="btnLogin">Entrar</button></div></div>
<div id="app-screen" class="hidden"><header class="header"><nav class="nav"><button class="nav-btn active" id="nav-dashboard">Dashboard</button><button class="nav-btn" id="nav-contratos">Contratos</button><button class="nav-btn" id="nav-vagas">Vagas</button><button class="nav-btn" id="nav-candidatos">Candidatos</button></nav><div class="header-actions"><button class="btn btn-wehandle btn-sm" id="btnWehandle">üì§ Wehandle</button><button class="btn btn-primary btn-sm" id="btnExportData">üì• Exportar</button><button class="btn btn-success btn-sm" id="btnRefresh">üîÑ Atualizar</button><span class="user-info" id="user-email"></span><button class="btn btn-outline btn-sm" id="btnLogout">Sair</button></div></header><main class="main"><div id="loading" class="loading"><div class="spinner"></div>Carregando dados...</div><div id="dashboard" class="hidden"></div><div id="contratos" class="hidden"></div><div id="vagas" class="hidden"></div><div id="candidatos" class="hidden"></div></main></div>
<div id="modal" class="modal-overlay hidden"><div class="modal"><h2 class="modal-title" id="modal-title"></h2><div id="modal-content"></div></div></div>
<script>
(function(){
const SUPABASE_URL='https://jocusweupkmzaqxkczjy.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvY3Vzd2V1cGttemFxeGtjemp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NDM3NDAsImV4cCI6MjA4NTIxOTc0MH0.wlSR8teEYnOVornAC0NU0CWHlg_1wrLlXSjvtWo47tU';
const sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const ETAPAS=['Abertura da Vaga','Capta√ß√£o','Triagem','Checagem Dados','Entrevista RH','Teste Pr√°tico','Proposta Benel','ASO','Docs pasta DP','Enviar para DP','Apto para Integra√ß√£o','Subir Doc. Portal','PT Cliente','Integra√ß√£o Cliente','Aprovado no Portal'];
const ESTADOS=['BA','RN'];
let contratos=[],vagas=[],candidatos=[],currentTab='dashboard',filterContratos=[],filterSearch='',filterEtapa='todos',filterEstado='todos',filterFuncao='todos',sortDir='asc';

async function init(){const{data:{session}}=await sb.auth.getSession();if(session)showApp(session.user);}

document.getElementById('btnLogin').onclick=async function(){
  const email=document.getElementById('login-email').value,pwd=document.getElementById('login-password').value;
  if(!email||!pwd){showErr('Preencha email e senha');return;}
  const{data,error}=await sb.auth.signInWithPassword({email,password:pwd});
  if(error){showErr('Email ou senha incorretos');return;}
  showApp(data.user);
};

document.getElementById('btnLogout').onclick=async function(){await sb.auth.signOut();document.getElementById('app-screen').classList.add('hidden');document.getElementById('login-screen').classList.remove('hidden');};
document.getElementById('btnRefresh').onclick=async function(){this.textContent='‚è≥ Atualizando...';this.disabled=true;await loadData();render();this.textContent='üîÑ Atualizar';this.disabled=false;showToast('‚úÖ Dados atualizados!');};
document.getElementById('btnWehandle').onclick=function(){openWehandleModal();};

document.getElementById('btnExportData').onclick=function(){
  const dados={exportDate:new Date().toISOString(),contratos,vagas,candidatos:candidatos.map(c=>({id:c.id,name:c.name,cpf:c.cpf,position_id:c.positionId,current_stage:c.currentStage,checklist:c.checklist,status:c.status}))};
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(dados,null,2)],{type:'application/json'}));a.download=`followup_dados_${new Date().toISOString().slice(0,10)}.json`;a.click();showToast('üì• Dados exportados!');
};

function showToast(msg){const t=document.createElement('div');t.style.cssText='position:fixed;bottom:20px;right:20px;background:#16a34a;color:#fff;padding:12px 24px;border-radius:8px;font-weight:500;z-index:9999';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),2500);}
document.getElementById('login-password').onkeypress=function(e){if(e.key==='Enter')document.getElementById('btnLogin').click();};
function showErr(m){const e=document.getElementById('login-error');e.textContent=m;e.classList.remove('hidden');}

async function showApp(user){
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app-screen').classList.remove('hidden');
  document.getElementById('user-email').textContent=user.email;
  document.getElementById('loading').classList.remove('hidden');
  await loadData();
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  render();
}

async function loadData(){
  const{data:ct}=await sb.from('contratos').select('*').order('id');
  const{data:v}=await sb.from('vagas').select('*').order('id');
  const{data:c}=await sb.from('candidatos').select('*').order('id');
  contratos=ct||[];vagas=v||[];
  candidatos=(c||[]).map(x=>({...x,positionId:x.position_id,currentStage:x.current_stage,checklist:x.checklist||Array(15).fill(false)}));
}

function isOk(c){return c.currentStage===14;}
function getContrato(v){return v?contratos.find(c=>c.id===v.contrato_id):null;}
function getVagasFiltradas(){return filterContratos.length===0?vagas:vagas.filter(v=>filterContratos.includes(v.contrato_id));}
function getCandidatosFiltrados(){const vids=getVagasFiltradas().map(v=>v.id);return candidatos.filter(c=>vids.includes(c.positionId));}

document.getElementById('nav-dashboard').onclick=function(){showTab('dashboard');};
document.getElementById('nav-contratos').onclick=function(){showTab('contratos');};
document.getElementById('nav-vagas').onclick=function(){showTab('vagas');};
document.getElementById('nav-candidatos').onclick=function(){showTab('candidatos');};

function showTab(t){currentTab=t;document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));document.getElementById('nav-'+t).classList.add('active');['dashboard','contratos','vagas','candidatos'].forEach(x=>document.getElementById(x).classList.add('hidden'));document.getElementById(t).classList.remove('hidden');render();}

function render(){if(currentTab==='dashboard')renderDash();else if(currentTab==='contratos')renderContratos();else if(currentTab==='vagas')renderVagas();else renderCands();}

/* ===== CONTRATO FILTER ===== */
function renderContratoFilter(){
  const ativos=contratos.filter(c=>c.ativo);
  let h=`<div class="contrato-filter"><label>üìã Contratos:</label><div style="display:flex;gap:16px;flex-wrap:wrap;align-items:center">`;
  h+=`<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px"><input type="checkbox" id="chkTodos" ${filterContratos.length===0?'checked':''} onchange="toggleTodosContratos(this.checked)" style="width:16px;height:16px"><span style="font-weight:${filterContratos.length===0?'600':'400'}">Todos</span></label>`;
  ativos.forEach(c=>{
    const checked=filterContratos.includes(c.id);
    h+=`<label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:13px"><input type="checkbox" data-contrato="${c.id}" ${checked?'checked':''} onchange="toggleContrato(${c.id},this.checked)" style="width:16px;height:16px"><span style="font-weight:${checked?'600':'400'};color:${checked?'#ea580c':'#374151'}">${c.nome}</span></label>`;
  });
  h+=`</div></div>`;
  return h;
}
function toggleTodosContratos(checked){if(checked){filterContratos=[];renderDash();}}
function toggleContrato(id,checked){if(checked){if(!filterContratos.includes(id))filterContratos.push(id);}else{filterContratos=filterContratos.filter(x=>x!==id);}renderDash();}

/* ===== DASHBOARD ===== */
function renderDash(){
  const vf=getVagasFiltradas(),cf=getCandidatosFiltrados();
  const tp=vf.reduce((s,v)=>s+v.quantity,0),tc=cf.length,okT=cf.filter(isOk).length,pT=tp-okT;
  const cBA=cf.filter(c=>vf.find(v=>v.id===c.positionId)?.state==='BA'),cRN=cf.filter(c=>vf.find(v=>v.id===c.positionId)?.state==='RN');
  const mBA=vf.filter(v=>v.state==='BA').reduce((s,v)=>s+v.quantity,0),mRN=vf.filter(v=>v.state==='RN').reduce((s,v)=>s+v.quantity,0);
  const oBA=cBA.filter(isOk).length,oRN=cRN.filter(isOk).length,pBA=mBA-oBA,pRN=mRN-oRN;
  const eg=tp>0?Math.round(okT/tp*100):0;
  const cpe=ETAPAS.map((_,i)=>cf.filter(c=>c.currentStage===i).length),epe=ETAPAS.map((_,i)=>tp>0?Math.round(cpe[i]/tp*100):0);
  
  let h=renderContratoFilter();
  h+=`<div class="grid-5"><div class="kpi blue-bg"><div class="kpi-label">Vagas Planejadas</div><div class="kpi-value blue">${tp}</div><div class="kpi-sub">${vf.length} tipos</div></div><div class="kpi purple-bg"><div class="kpi-label">Total Candidatos</div><div class="kpi-value purple">${tc}</div><div class="kpi-sub">BA:${cBA.length}|RN:${cRN.length}</div></div><div class="kpi green-bg"><div class="kpi-label">Conclu√≠dos</div><div class="kpi-value green">${okT}</div><div class="kpi-sub">BA:${oBA}|RN:${oRN}</div></div><div class="kpi ${pT>0?'yellow-bg':'green-bg'}"><div class="kpi-label">Faltam p/ Meta</div><div class="kpi-value ${pT>0?'yellow':'green'}">${pT}</div><div class="kpi-sub">BA:${pBA}|RN:${pRN}</div></div><div class="kpi ${eg>=80?'green-bg':eg>=50?'yellow-bg':'red-bg'}"><div class="kpi-label">Efici√™ncia</div><div class="kpi-value ${eg>=80?'green':eg>=50?'yellow':'red'}">${eg}%</div></div></div>`;
  h+=`<div class="card"><div class="ef-section"><div class="ef-title">üìä Vis√£o Geral</div><div class="etapas-row">${ETAPAS.map((et,i)=>`<div class="etapa-card"><div class="etapa-name">${et}</div><div class="etapa-qty" data-etapa-geral="${i}" style="${cpe[i]>0?'cursor:pointer;text-decoration:underline':''}">${cpe[i]||'-'}</div><div class="etapa-ef" style="background:${cpe[i]>0?(epe[i]>=50?'#dcfce7':'#fef9c3'):'transparent'};color:${cpe[i]>0?(epe[i]>=50?'#16a34a':'#ca8a04'):'#9ca3af'}">${epe[i]}%</div></div>`).join('')}</div></div>`;
  
  const contratosAtivos=contratos.filter(c=>c.ativo);
  h+=`<div class="ef-section"><div class="ef-title">üéØ Follow Up por Fun√ß√£o</div><div class="funcoes-grid">`;
  contratosAtivos.forEach(contrato=>{
    const vagasContrato=vf.filter(v=>v.contrato_id===contrato.id);
    const funcsContrato=[...new Set(vagasContrato.map(v=>v.title))];
    funcsContrato.forEach(func=>{
      const ds=[];
      ['BA','RN'].forEach(est=>{
        const vg=vagasContrato.find(v=>v.title===func&&v.state===est);
        if(!vg)return;
        const cs=cf.filter(c=>c.positionId===vg.id);
        const pe=ETAPAS.map((_,i)=>({i,n:ETAPAS[i],q:cs.filter(c=>c.currentStage===i).length})).filter(e=>e.q>0).sort((a,b)=>a.i-b.i);
        ds.push({est,vg,pe,t:cs.length,ok:cs.filter(isOk).length,m:vg.quantity});
      });
      if(!ds.length)return;
      h+=`<div class="funcao-card"><div class="funcao-header">${func}<div style="font-size:11px;font-weight:400;opacity:0.9;margin-top:2px">${contrato.nome}</div></div><div class="funcao-body-grid">`;
      ds.forEach(d=>{const f=d.m-d.ok;h+=`<div class="uf-col"><div class="uf-header-box uf-${d.est.toLowerCase()}"><div class="uf-nome">${d.est==='BA'?'Bahia':'RN'}</div><div class="uf-total-num">${d.t} <span>cand.</span></div><div style="margin-top:4px;font-size:12px;color:#1e40af;font-weight:600">Meta:${d.m}</div><div style="margin-top:4px;font-size:12px;font-weight:700;color:${f>0?'#dc2626':'#16a34a'}">${f>0?'Faltam:'+f:'‚úì Atingida!'}</div></div><div class="etapas-lista">`;d.pe.forEach(e=>{h+=`<div class="etapa-item ${e.i===14?'etapa-aprovado':''}" data-vaga="${d.vg.id}" data-etapa="${e.i}"><span class="etapa-item-qty">${e.q}</span><span class="etapa-item-name">${e.n}</span></div>`;});h+=`</div><div class="uf-resumo-box"><div class="resumo-processo"><span class="resumo-num">${d.t-d.ok}</span><span class="resumo-label">‚è≥ processo</span></div><div class="resumo-aprovado"><span class="resumo-num">${d.ok}</span><span class="resumo-label">‚úÖ ok</span></div></div></div>`;});
      h+=`</div></div>`;
    });
  });
  h+=`</div></div></div>`;
  document.getElementById('dashboard').innerHTML=h;
  document.querySelectorAll('.etapa-item').forEach(el=>{el.onclick=function(){showCandEtapa(+this.dataset.vaga,+this.dataset.etapa);};});
  document.querySelectorAll('[data-etapa-geral]').forEach(el=>{if(el.textContent!=='-')el.onclick=function(){showCandEtapaGeral(+this.dataset.etapaGeral);};});
}

/* ===== MODAL ETAPA POR VAGA ===== */
function showCandEtapa(vid,eidx){
  const vg=vagas.find(v=>v.id===vid),cs=candidatos.filter(c=>c.positionId===vid&&c.currentStage===eidx),ct=getContrato(vg);
  document.getElementById('modal-title').textContent=ETAPAS[eidx];
  let tbody='';
  cs.forEach((c,i)=>{tbody+=`<tr><td>${i+1}</td><td>${c.name}</td><td><span class="contrato-badge" style="background:#fff7ed;color:#ea580c">${ct?.nome||'-'}</span></td><td class="center"><button class="btn btn-primary btn-sm" data-id="${c.id}">Checklist</button></td></tr>`;});
  document.getElementById('modal-content').innerHTML=`<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-bottom:16px"><div style="font-size:13px;color:#64748b">Vaga:<strong style="color:#1e40af">${vg.title}</strong> - ${vg.state}</div><div style="font-size:13px;color:#64748b">Total:<strong style="color:#16a34a">${cs.length}</strong></div></div><div style="max-height:350px;overflow-y:auto">${cs.length?`<table><thead><tr><th>#</th><th>Nome</th><th>Contrato</th><th class="center">A√ß√£o</th></tr></thead><tbody>${tbody}</tbody></table>`:'<p style="text-align:center;color:#64748b;padding:20px">Nenhum</p>'}</div><div class="btn-group" style="margin-top:16px"><button class="btn btn-success" style="flex:1" id="exportEtapaVagaBtn">üìä Excel</button><button class="btn btn-outline" style="flex:1" id="closeModalBtn">Fechar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('closeModalBtn').onclick=closeModal;
  document.getElementById('exportEtapaVagaBtn').onclick=function(){let csv='\uFEFF#;Nome;Fun√ß√£o;Estado;Contrato;Etapa\n';cs.forEach((c,i)=>{csv+=`${i+1};${c.name};${vg.title};${vg.state};${ct?.nome||'N/A'};${ETAPAS[eidx]}\n`;});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=`${vg.title.replace(/\s+/g,'_')}_${vg.state}_etapa${eidx+1}.csv`;a.click();showToast('üìä Excel exportado!');};
  document.querySelectorAll('#modal-content .btn-primary').forEach(b=>{b.onclick=function(){closeModal();setTimeout(()=>openCheck(+this.dataset.id),100);};});
}

/* ===== MODAL ETAPA GERAL ===== */
function showCandEtapaGeral(eidx){
  const cf=getCandidatosFiltrados(),cs=cf.filter(c=>c.currentStage===eidx);
  document.getElementById('modal-title').textContent=ETAPAS[eidx];
  let tbody='';cs.forEach((c,i)=>{const vg=vagas.find(v=>v.id===c.positionId),ct=getContrato(vg);tbody+=`<tr><td>${i+1}</td><td>${c.name}</td><td>${vg?.title||'-'}</td><td>${vg?.state||'-'}</td><td>${ct?.nome||'-'}</td><td class="center"><button class="btn btn-primary btn-sm" data-id="${c.id}">Checklist</button></td></tr>`;});
  document.getElementById('modal-content').innerHTML=`<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-bottom:16px"><div style="font-size:13px;color:#64748b">Etapa:<strong style="color:#1e40af">${eidx+1}. ${ETAPAS[eidx]}</strong></div><div style="font-size:13px;color:#64748b">Total:<strong style="color:#16a34a">${cs.length}</strong></div></div><div style="max-height:400px;overflow-y:auto">${cs.length?`<table><thead><tr><th>#</th><th>Nome</th><th>Fun√ß√£o</th><th>UF</th><th>Contrato</th><th class="center">A√ß√£o</th></tr></thead><tbody>${tbody}</tbody></table>`:'<p style="text-align:center;color:#64748b;padding:20px">Nenhum</p>'}</div><div class="btn-group" style="margin-top:16px"><button class="btn btn-success" style="flex:1" id="exportEtapaBtn">üìä Excel</button><button class="btn btn-outline" style="flex:1" id="closeModalBtn">Fechar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('closeModalBtn').onclick=closeModal;
  document.getElementById('exportEtapaBtn').onclick=function(){let csv='\uFEFF#;Nome;Fun√ß√£o;Estado;Contrato;Etapa\n';cs.forEach((c,i)=>{const vg=vagas.find(v=>v.id===c.positionId),ct=getContrato(vg);csv+=`${i+1};${c.name};${vg?.title||'N/A'};${vg?.state||'N/A'};${ct?.nome||'N/A'};${ETAPAS[eidx]}\n`;});const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=`etapa_${eidx+1}_${ETAPAS[eidx].replace(/\s+/g,'_')}.csv`;a.click();showToast('üìä Excel exportado!');};
  document.querySelectorAll('#modal-content .btn-primary').forEach(b=>{b.onclick=function(){closeModal();setTimeout(()=>openCheck(+this.dataset.id),100);};});
}

/* ===== CHECKLIST ===== */
function openCheck(id){
  const c=candidatos.find(x=>x.id===id),v=vagas.find(x=>x.id===c.positionId),ct=getContrato(v);
  if(!c.checklist)c.checklist=Array(15).fill(false);
  let checklistTemp=[...c.checklist];
  function renderCheckModal(){
    const okNow=checklistTemp[14];
    let h=`<div style="background:#f1f5f9;padding:12px;border-radius:8px;margin-bottom:16px"><div style="font-size:14px;font-weight:600">${c.name}</div><div style="font-size:12px;color:#64748b">${v?.title||'N/A'} - ${v?.state||''}</div><div style="font-size:12px;color:#ea580c;font-weight:500">${ct?.nome||''}</div><div style="margin-top:8px">${okNow?'<span style="background:#dcfce7;color:#16a34a;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600">‚úÖ CONCLU√çDO</span>':'<span style="background:#fef3c7;color:#92400e;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600">‚è≥ PROCESSO</span>'}</div></div><div style="max-height:320px;overflow-y:auto">`;
    ETAPAS.forEach((et,i)=>{const ch=checklistTemp[i];h+=`<label style="display:flex;align-items:center;gap:10px;padding:8px 10px;margin-bottom:4px;background:${ch?'#f0fdf4':'#fff'};border:1px solid ${ch?'#86efac':'#e2e8f0'};border-radius:6px;cursor:pointer"><input type="checkbox" ${ch?'checked':''} data-idx="${i}" style="width:18px;height:18px"><span style="flex:1;font-size:13px;color:${ch?'#16a34a':'#334155'};font-weight:${ch?'600':'400'}">${i+1}.${et}</span>${ch?'<span style="color:#16a34a">‚úì</span>':''}</label>`;});
    h+=`</div><div class="btn-group" style="margin-top:16px"><button class="btn btn-outline" style="flex:1" id="markAllTemp">‚úì Todas</button><button class="btn btn-outline" style="flex:1" id="clearAllTemp">‚úó Limpar</button></div><div class="btn-group" style="margin-top:8px"><button class="btn btn-success" style="flex:1" id="saveCheck">üíæ Salvar</button><button class="btn btn-danger" style="flex:1" id="cancelCheck">‚úó Cancelar</button></div>`;
    document.getElementById('modal-content').innerHTML=h;
    document.getElementById('modal-title').textContent='Checklist';
    document.querySelectorAll('#modal-content input[type=checkbox]').forEach(cb=>{cb.onchange=function(){checklistTemp[+this.dataset.idx]=this.checked;renderCheckModal();};});
    document.getElementById('markAllTemp').onclick=function(){checklistTemp=Array(15).fill(true);renderCheckModal();};
    document.getElementById('clearAllTemp').onclick=function(){checklistTemp=Array(15).fill(false);renderCheckModal();};
    document.getElementById('saveCheck').onclick=async function(){let l=-1;for(let i=14;i>=0;i--)if(checklistTemp[i]){l=i;break;}c.checklist=[...checklistTemp];c.currentStage=l>=0?l:0;await sb.from('candidatos').update({checklist:c.checklist,current_stage:c.currentStage}).eq('id',id);showToast('‚úÖ Checklist salvo!');closeModal();render();};
    document.getElementById('cancelCheck').onclick=function(){closeModal();render();};
  }
  renderCheckModal();
  document.getElementById('modal').classList.remove('hidden');
}

/* ===== CONTRATOS ===== */
function renderContratos(){
  let h=`<div class="page-header"><h1 class="page-title">Contratos</h1><button class="btn btn-primary" id="newContrato">+ Novo Contrato</button></div><div class="card" style="padding:0"><table><thead><tr><th>Nome</th><th>Empresa</th><th>CNPJ</th><th class="center">Vagas</th><th class="center">Candidatos</th><th class="center">Status</th><th class="center">A√ß√µes</th></tr></thead><tbody>`;
  contratos.forEach(ct=>{const vg=vagas.filter(v=>v.contrato_id===ct.id),cd=candidatos.filter(c=>vg.map(v=>v.id).includes(c.positionId));const cnpjFmt=ct.cnpj?ct.cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/,'$1.$2.$3/$4-$5'):'‚Äî';h+=`<tr><td><strong>${ct.nome}</strong></td><td>${ct.empresa}</td><td style="font-family:monospace;font-size:11px">${cnpjFmt}</td><td class="center"><span class="badge-pill" style="background:#dbeafe;color:#1d4ed8">${vg.length}</span></td><td class="center"><span class="badge-pill" style="background:#f3e8ff;color:#7c3aed">${cd.length}</span></td><td class="center">${ct.ativo?'<span style="background:#dcfce7;color:#16a34a;padding:2px 8px;border-radius:4px;font-size:11px">Ativo</span>':'<span style="background:#fee2e2;color:#dc2626;padding:2px 8px;border-radius:4px;font-size:11px">Inativo</span>'}</td><td class="center"><button class="btn btn-outline btn-sm" data-edit-ct="${ct.id}">Editar</button> <button class="btn btn-danger btn-sm" data-del-ct="${ct.id}">Del</button></td></tr>`;});
  h+=`</tbody></table></div>`;
  document.getElementById('contratos').innerHTML=h;
  document.getElementById('newContrato').onclick=function(){openContratoModal();};
  document.querySelectorAll('[data-edit-ct]').forEach(b=>{b.onclick=function(){openContratoModal(+this.dataset.editCt);};});
  document.querySelectorAll('[data-del-ct]').forEach(b=>{b.onclick=function(){const id=+this.dataset.delCt,ct=contratos.find(x=>x.id===id),vg=vagas.filter(v=>v.contrato_id===id);confirmDelete('contrato',ct.nome,`${vg.length} vagas vinculadas`,async()=>{await sb.from('contratos').delete().eq('id',id);contratos=contratos.filter(x=>x.id!==id);render();showToast('üóëÔ∏è Contrato exclu√≠do!');});};});
}

function openContratoModal(id){
  const ct=id?contratos.find(x=>x.id===id):null;
  document.getElementById('modal-title').textContent=ct?'Editar Contrato':'Novo Contrato';
  document.getElementById('modal-content').innerHTML=`<div class="form-group"><label class="required">Nome do Contrato</label><input type="text" id="ctNome" value="${ct?.nome||''}" placeholder="Ex: Petroreconcavo"></div><div class="form-group"><label class="required">Empresa</label><input type="text" id="ctEmpresa" value="${ct?.empresa||''}" placeholder="Ex: Petroreconcavo"></div><div class="form-group"><label class="required">CNPJ da Unidade</label><input type="text" id="ctCnpj" value="${ct?.cnpj||''}" placeholder="Somente n√∫meros: 00000000000000" style="font-family:monospace"></div><div class="info-box">‚ÑπÔ∏è O CNPJ ser√° usado na exporta√ß√£o Wehandle como "Identifica√ß√£o Fiscal da Unidade"</div><div class="form-group"><label><input type="checkbox" id="ctAtivo" ${ct?.ativo!==false?'checked':''}> Contrato Ativo</label></div><div class="btn-group"><button class="btn btn-primary" style="flex:1" id="saveContrato">Salvar</button><button class="btn btn-outline" style="flex:1" id="cancelContrato">Cancelar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('cancelContrato').onclick=closeModal;
  document.getElementById('saveContrato').onclick=async function(){
    const nome=document.getElementById('ctNome').value.trim(),empresa=document.getElementById('ctEmpresa').value.trim(),cnpj=document.getElementById('ctCnpj').value.replace(/\D/g,''),ativo=document.getElementById('ctAtivo').checked;
    if(!nome||!empresa){alert('Preencha Nome e Empresa');return;}
    if(id){await sb.from('contratos').update({nome,empresa,cnpj,ativo}).eq('id',id);const c=contratos.find(x=>x.id===id);c.nome=nome;c.empresa=empresa;c.cnpj=cnpj;c.ativo=ativo;showToast('‚úÖ Contrato atualizado!');}
    else{const{data}=await sb.from('contratos').insert({nome,empresa,cnpj,ativo}).select();if(data)contratos.push(data[0]);showToast('‚úÖ Contrato criado!');}
    closeModal();render();
  };
}

/* ===== VAGAS ===== */
function renderVagas(){
  let h=`<div class="page-header"><h1 class="page-title">Vagas</h1><button class="btn btn-primary" id="newVaga">+ Nova Vaga</button></div><div class="card" style="padding:0"><table><thead><tr><th>Vaga</th><th>Estado</th><th>Contrato</th><th class="center">CBO</th><th class="center">Sal√°rio</th><th class="center">Meta</th><th class="center">Cands</th><th class="center">A√ß√µes</th></tr></thead><tbody>`;
  vagas.forEach(v=>{const ct=getContrato(v);h+=`<tr><td>${v.title}</td><td>${v.state}</td><td><span class="contrato-badge" style="background:#fff7ed;color:#ea580c">${ct?.nome||'Sem contrato'}</span></td><td class="center" style="font-family:monospace">${v.cbo||'<span style="color:#dc2626">‚Äî</span>'}</td><td class="center">${v.salario?'R$ '+v.salario:'<span style="color:#dc2626">‚Äî</span>'}</td><td class="center"><span class="badge-pill" style="background:#dbeafe;color:#1d4ed8">${v.quantity}</span></td><td class="center"><span class="badge-pill" style="background:#f3e8ff;color:#7c3aed">${candidatos.filter(c=>c.positionId===v.id).length}</span></td><td class="center"><button class="btn btn-outline btn-sm" data-edit="${v.id}">Editar</button> <button class="btn btn-danger btn-sm" data-del="${v.id}">Del</button></td></tr>`;});
  h+=`</tbody></table></div>`;
  document.getElementById('vagas').innerHTML=h;
  document.getElementById('newVaga').onclick=function(){openVagaModal();};
  document.querySelectorAll('[data-edit]').forEach(b=>{b.onclick=function(){openVagaModal(+this.dataset.edit);};});
  document.querySelectorAll('[data-del]').forEach(b=>{b.onclick=function(){const id=+this.dataset.del,v=vagas.find(x=>x.id===id),numCands=candidatos.filter(c=>c.positionId===id).length;confirmDelete('vaga',v.title,`Estado: ${v.state} | ${numCands} candidatos`,async()=>{await sb.from('candidatos').delete().eq('position_id',id);await sb.from('vagas').delete().eq('id',id);vagas=vagas.filter(x=>x.id!==id);candidatos=candidatos.filter(c=>c.positionId!==id);render();showToast('üóëÔ∏è Vaga exclu√≠da!');});};});
}

function openVagaModal(id){
  const v=id?vagas.find(x=>x.id===id):null;
  document.getElementById('modal-title').textContent=v?'Editar Vaga':'Nova Vaga';
  document.getElementById('modal-content').innerHTML=`<div class="form-group"><label class="required">Contrato</label><select id="vContrato"><option value="">Selecione o Contrato</option>${contratos.filter(c=>c.ativo).map(c=>`<option value="${c.id}" ${v?.contrato_id===c.id?'selected':''}>${c.nome}</option>`).join('')}</select></div><div class="form-group"><label class="required">Nome da Vaga</label><input type="text" id="vTitle" value="${v?.title||''}"></div><div class="form-row"><div class="form-group"><label class="required">Estado</label><select id="vState">${ESTADOS.map(e=>`<option value="${e}" ${v?.state===e?'selected':''}>${e}</option>`).join('')}</select></div><div class="form-group"><label class="required">Meta</label><input type="number" id="vQty" value="${v?.quantity||1}"></div></div><div class="section-divider">Dados Wehandle</div><div class="form-row"><div class="form-group"><label class="required">CBO</label><input type="text" id="vCbo" value="${v?.cbo||''}" placeholder="Ex: 782510" style="font-family:monospace"></div><div class="form-group"><label class="required">Sal√°rio (R$)</label><input type="text" id="vSalario" value="${v?.salario||''}" placeholder="Ex: 2648,00"></div></div><div class="info-box">‚ÑπÔ∏è CBO e Sal√°rio ser√£o usados na exporta√ß√£o Wehandle</div><div class="btn-group"><button class="btn btn-primary" style="flex:1" id="saveVaga">Salvar</button><button class="btn btn-outline" style="flex:1" id="cancelVaga">Cancelar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('cancelVaga').onclick=closeModal;
  document.getElementById('saveVaga').onclick=async function(){
    const contrato_id=parseInt(document.getElementById('vContrato').value)||null,t=document.getElementById('vTitle').value.trim(),s=document.getElementById('vState').value,q=parseInt(document.getElementById('vQty').value)||1,cbo=document.getElementById('vCbo').value.trim(),salario=document.getElementById('vSalario').value.trim();
    if(!t){alert('Preencha o nome');return;}if(!contrato_id){alert('Selecione um contrato');return;}
    if(id){await sb.from('vagas').update({title:t,state:s,quantity:q,contrato_id,cbo,salario}).eq('id',id);const vv=vagas.find(x=>x.id===id);vv.title=t;vv.state=s;vv.quantity=q;vv.contrato_id=contrato_id;vv.cbo=cbo;vv.salario=salario;showToast('‚úÖ Vaga atualizada!');}
    else{const{data}=await sb.from('vagas').insert({title:t,state:s,quantity:q,contrato_id,cbo,salario}).select();if(data)vagas.push(data[0]);showToast('‚úÖ Vaga criada!');}
    closeModal();render();
  };
}

/* ===== CANDIDATOS ===== */
function renderCands(){
  const funcs=[...new Set(vagas.map(v=>v.title))];
  const ativos=contratos.filter(c=>c.ativo);
  let contratoCheckboxes=`<label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;white-space:nowrap"><input type="checkbox" id="chkTodosCand" ${filterContratos.length===0?'checked':''} style="width:14px;height:14px"><span>Todos</span></label>`;
  ativos.forEach(c=>{contratoCheckboxes+=`<label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:12px;white-space:nowrap"><input type="checkbox" class="chkContratoCand" data-ct="${c.id}" ${filterContratos.includes(c.id)?'checked':''} style="width:14px;height:14px"><span>${c.nome}</span></label>`;});
  let h=`<div class="page-header"><h1 class="page-title">Candidatos</h1><div class="btn-group"><button class="btn btn-wehandle" id="expWehandle">üì§ Wehandle</button><button class="btn btn-success" id="expExcel">üìä Excel</button><button class="btn btn-primary" id="newCand">+ Novo</button></div></div><div class="card"><div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px"><span style="font-weight:600;font-size:13px">üìã Contratos:</span>${contratoCheckboxes}</div><div class="filters"><input type="text" placeholder="Buscar..." id="fSearch" value="${filterSearch}"><select id="fEtapa"><option value="todos">Todas Etapas</option>${ETAPAS.map((e,i)=>`<option value="${i}" ${filterEtapa==i?'selected':''}>${i+1}.${e}</option>`).join('')}</select><select id="fEstado"><option value="todos">Todos Estados</option>${ESTADOS.map(e=>`<option value="${e}" ${filterEstado===e?'selected':''}>${e}</option>`).join('')}</select><select id="fFuncao"><option value="todos">Todas Fun√ß√µes</option>${funcs.map(f=>`<option value="${f}" ${filterFuncao===f?'selected':''}>${f}</option>`).join('')}</select></div></div><div class="card" style="padding:0"><table><thead><tr><th style="cursor:pointer" id="sortName">Nome</th><th>CPF</th><th>Vaga</th><th>Contrato</th><th>Etapa</th><th>Admiss√£o</th><th class="center">A√ß√µes</th></tr></thead><tbody id="tbCand"></tbody></table></div>`;
  document.getElementById('candidatos').innerHTML=h;
  document.getElementById('fSearch').oninput=function(){filterSearch=this.value;renderTbl();};
  document.getElementById('chkTodosCand').onchange=function(){if(this.checked){filterContratos=[];renderCands();}};
  document.querySelectorAll('.chkContratoCand').forEach(cb=>{cb.onchange=function(){const id=+this.dataset.ct;if(this.checked){if(!filterContratos.includes(id))filterContratos.push(id);}else{filterContratos=filterContratos.filter(x=>x!==id);}renderCands();};});
  document.getElementById('fEtapa').onchange=function(){filterEtapa=this.value;renderTbl();};
  document.getElementById('fEstado').onchange=function(){filterEstado=this.value;renderTbl();};
  document.getElementById('fFuncao').onchange=function(){filterFuncao=this.value;renderTbl();};
  document.getElementById('sortName').onclick=function(){sortDir=sortDir==='asc'?'desc':'asc';renderTbl();};
  document.getElementById('newCand').onclick=openCandModal;
  document.getElementById('expExcel').onclick=expExcel;
  document.getElementById('expWehandle').onclick=openWehandleModal;
  renderTbl();
}

function renderTbl(){
  let f=candidatos.filter(c=>{
    const v=vagas.find(x=>x.id===c.positionId);
    const ctMatch=filterContratos.length===0||filterContratos.includes(v?.contrato_id);
    return c.name.toLowerCase().includes(filterSearch.toLowerCase())&&ctMatch&&(filterEtapa==='todos'||c.currentStage===parseInt(filterEtapa))&&(filterEstado==='todos'||(v&&v.state===filterEstado))&&(filterFuncao==='todos'||(v&&v.title===filterFuncao));
  });
  f.sort((a,b)=>sortDir==='asc'?a.name.localeCompare(b.name):b.name.localeCompare(a.name));
  let h='';
  f.slice(0,200).forEach(c=>{const v=vagas.find(x=>x.id===c.positionId),ct=getContrato(v),ok=isOk(c),m=c.checklist?c.checklist.filter(x=>x).length:0;const admFmt=c.data_admissao?new Date(c.data_admissao+'T12:00:00').toLocaleDateString('pt-BR'):'-';h+=`<tr style="${ok?'background:#f0fdf4':''}"><td>${c.name}${ok?' <span style="background:#dcfce7;color:#16a34a;padding:2px 6px;border-radius:10px;font-size:10px">‚úì</span>':''}</td><td style="font-family:monospace;font-size:11px">${c.cpf||'<span style="color:#9ca3af">‚Äî</span>'}</td><td class="text-gray">${v?.title||'-'} - ${v?.state||''}</td><td><span class="contrato-badge" style="background:#fff7ed;color:#ea580c">${ct?.nome||'-'}</span></td><td><span class="badge" style="background:${ok?'#dcfce7':'#dbeafe'};color:${ok?'#16a34a':'#1d4ed8'}">${c.currentStage+1}.${ETAPAS[c.currentStage]}</span></td><td style="font-size:11px">${admFmt}</td><td><div style="display:flex;gap:4px;justify-content:center"><button class="btn btn-primary btn-sm" data-editc="${c.id}">Editar</button><button class="btn btn-outline btn-sm" data-check="${c.id}">Check</button><button class="btn btn-danger btn-sm" data-delc="${c.id}">Del</button></div></td></tr>`;});
  document.getElementById('tbCand').innerHTML=h;
  document.querySelectorAll('[data-editc]').forEach(b=>{b.onclick=function(){openCandEditModal(+this.dataset.editc);};});
  document.querySelectorAll('[data-check]').forEach(b=>{b.onclick=function(){openCheck(+this.dataset.check);};});
  document.querySelectorAll('[data-delc]').forEach(b=>{b.onclick=function(){const id=+this.dataset.delc,c=candidatos.find(x=>x.id===id),v=vagas.find(x=>x.id===c.positionId),ct=getContrato(v);confirmDelete('candidato',c.name,`${v?.title||'N/A'} - ${v?.state||''} | ${ct?.nome||''}`,async()=>{await sb.from('candidatos').delete().eq('id',id);candidatos=candidatos.filter(x=>x.id!==id);renderTbl();showToast('üóëÔ∏è Candidato exclu√≠do!');});};});
}

/* ===== NOVO CANDIDATO ===== */
function openCandModal(){
  document.getElementById('modal-title').textContent='Novo Candidato';
  document.getElementById('modal-content').innerHTML=`<div class="section-divider">Dados B√°sicos</div><div class="form-group"><label class="required">Nome Completo</label><input type="text" id="cName" placeholder="Nome completo"></div><div class="form-row"><div class="form-group"><label>CPF</label><input type="text" id="cCpf" placeholder="Somente n√∫meros" style="font-family:monospace"></div><div class="form-group"><label class="required">Vaga</label><select id="cVaga"><option value="">Selecione</option>${vagas.map(v=>{const ct=getContrato(v);return`<option value="${v.id}">${v.title} - ${v.state} (${ct?.nome||''})</option>`;}).join('')}</select></div></div><div class="form-group"><label>Etapa Atual</label><select id="cEtapa">${ETAPAS.map((e,i)=>`<option value="${i}">${i+1}.${e}</option>`).join('')}</select></div><div class="section-divider">Dados Pessoais (Wehandle)</div><div class="form-row-3"><div class="form-group"><label>Email</label><input type="email" id="cEmail" placeholder="email@exemplo.com"></div><div class="form-group"><label>Sexo</label><select id="cSexo"><option value="">Selecione</option><option>Masculino</option><option>Feminino</option></select></div><div class="form-group"><label>Dt. Nascimento</label><input type="date" id="cNasc"></div></div><div class="form-group"><label>Data Admiss√£o</label><input type="date" id="cAdm"></div><div class="section-divider">Endere√ßo (Wehandle)</div><div class="form-row-3"><div class="form-group"><label>CEP</label><input type="text" id="cCep" placeholder="00000000" style="font-family:monospace"></div><div class="form-group" style="grid-column:span 2"><label>Endere√ßo</label><input type="text" id="cEnd" placeholder="Rua, Av..."></div></div><div class="form-row"><div class="form-group"><label>N√∫mero</label><input type="text" id="cNum" placeholder="123"></div><div class="form-group"><label>OBS</label><input type="text" id="cObs" placeholder="Observa√ß√µes"></div></div><div class="info-box">‚ÑπÔ∏è Campos Wehandle podem ser preenchidos depois via "Editar"</div><div class="btn-group" style="margin-top:16px"><button class="btn btn-primary" style="flex:1" id="saveCand">Salvar</button><button class="btn btn-outline" style="flex:1" id="cancelCand">Cancelar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('cancelCand').onclick=closeModal;
  document.getElementById('saveCand').onclick=async function(){
    const n=document.getElementById('cName').value.trim(),p=parseInt(document.getElementById('cVaga').value),s=parseInt(document.getElementById('cEtapa').value)||0;
    const cpf=document.getElementById('cCpf').value.replace(/\D/g,''),email=document.getElementById('cEmail').value.trim(),sexo=document.getElementById('cSexo').value,data_nascimento=document.getElementById('cNasc').value||null,data_admissao=document.getElementById('cAdm').value||null,cep=document.getElementById('cCep').value.replace(/\D/g,''),endereco=document.getElementById('cEnd').value.trim(),numero_endereco=document.getElementById('cNum').value.trim(),obs=document.getElementById('cObs').value.trim();
    if(!n){alert('Preencha o nome');return;}if(!p){alert('Selecione uma vaga');return;}
    const ch=Array(15).fill(false);for(let i=0;i<=s;i++)ch[i]=true;
    const{data}=await sb.from('candidatos').insert({name:n,position_id:p,current_stage:s,status:'in_process',checklist:ch,cpf:cpf||null,email:email||null,sexo:sexo||null,data_nascimento,data_admissao,cep:cep||null,endereco:endereco||null,numero_endereco:numero_endereco||null,obs:obs||null}).select();
    if(data){candidatos.push({...data[0],positionId:data[0].position_id,currentStage:data[0].current_stage});showToast('‚úÖ Candidato adicionado!');}
    closeModal();render();
  };
}

/* ===== EDITAR CANDIDATO ===== */
function openCandEditModal(id){
  const c=candidatos.find(x=>x.id===id),v=vagas.find(x=>x.id===c.positionId),ct=getContrato(v);
  document.getElementById('modal-title').textContent='Editar Candidato';
  document.getElementById('modal-content').innerHTML=`<div class="section-divider">Dados B√°sicos</div><div class="form-group"><label class="required">Nome Completo</label><input type="text" id="eName" value="${c.name}"></div><div class="form-row"><div class="form-group"><label>CPF</label><input type="text" id="eCpf" value="${c.cpf||''}" style="font-family:monospace"></div><div class="form-group"><label class="required">Vaga</label><select id="eVaga">${vagas.map(vv=>{const cct=getContrato(vv);return`<option value="${vv.id}" ${vv.id===c.positionId?'selected':''}>${vv.title} - ${vv.state} (${cct?.nome||''})</option>`;}).join('')}</select></div></div><div class="section-divider">Dados Pessoais (Wehandle)</div><div class="form-row-3"><div class="form-group"><label>Email</label><input type="email" id="eEmail" value="${c.email||''}"></div><div class="form-group"><label>Sexo</label><select id="eSexo"><option value="">Selecione</option><option ${c.sexo==='Masculino'?'selected':''}>Masculino</option><option ${c.sexo==='Feminino'?'selected':''}>Feminino</option></select></div><div class="form-group"><label>Dt. Nascimento</label><input type="date" id="eNasc" value="${c.data_nascimento||''}"></div></div><div class="form-group"><label>Data Admiss√£o</label><input type="date" id="eAdm" value="${c.data_admissao||''}"></div><div class="section-divider">Endere√ßo (Wehandle)</div><div class="form-row-3"><div class="form-group"><label>CEP</label><input type="text" id="eCep" value="${c.cep||''}" style="font-family:monospace"></div><div class="form-group" style="grid-column:span 2"><label>Endere√ßo</label><input type="text" id="eEnd" value="${c.endereco||''}"></div></div><div class="form-row"><div class="form-group"><label>N√∫mero</label><input type="text" id="eNum" value="${c.numero_endereco||''}"></div><div class="form-group"><label>OBS</label><input type="text" id="eObs" value="${c.obs||''}"></div></div><div class="btn-group" style="margin-top:16px"><button class="btn btn-primary" style="flex:1" id="saveEdit">Salvar</button><button class="btn btn-outline" style="flex:1" id="cancelEdit">Cancelar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('cancelEdit').onclick=closeModal;
  document.getElementById('saveEdit').onclick=async function(){
    const name=document.getElementById('eName').value.trim(),position_id=parseInt(document.getElementById('eVaga').value);
    const cpf=document.getElementById('eCpf').value.replace(/\D/g,''),email=document.getElementById('eEmail').value.trim(),sexo=document.getElementById('eSexo').value,data_nascimento=document.getElementById('eNasc').value||null,data_admissao=document.getElementById('eAdm').value||null,cep=document.getElementById('eCep').value.replace(/\D/g,''),endereco=document.getElementById('eEnd').value.trim(),numero_endereco=document.getElementById('eNum').value.trim(),obs=document.getElementById('eObs').value.trim();
    if(!name){alert('Preencha o nome');return;}
    await sb.from('candidatos').update({name,position_id,cpf:cpf||null,email:email||null,sexo:sexo||null,data_nascimento,data_admissao,cep:cep||null,endereco:endereco||null,numero_endereco:numero_endereco||null,obs:obs||null}).eq('id',id);
    c.name=name;c.positionId=position_id;c.position_id=position_id;c.cpf=cpf||null;c.email=email||null;c.sexo=sexo||null;c.data_nascimento=data_nascimento;c.data_admissao=data_admissao;c.cep=cep||null;c.endereco=endereco||null;c.numero_endereco=numero_endereco||null;c.obs=obs||null;
    showToast('‚úÖ Dados salvos!');closeModal();render();
  };
}

/* ===== EXPORTAR WEHANDLE ===== */
function openWehandleModal(){
  const aprovados=candidatos.filter(isOk);
  const comCpf=aprovados.filter(c=>c.cpf);
  const semCpf=aprovados.filter(c=>!c.cpf);
  const completos=aprovados.filter(c=>c.cpf&&c.email&&c.sexo&&c.data_nascimento);
  
  let ctOptions=contratos.filter(c=>c.ativo).map(c=>`<option value="${c.id}">${c.nome}</option>`).join('');
  
  document.getElementById('modal-title').textContent='üì§ Exportar para Wehandle';
  document.getElementById('modal-content').innerHTML=`<div class="info-box" style="background:#faf5ff;border-color:#c4b5fd;color:#7c3aed"><strong>Layout Wehandle:</strong> Exporta candidatos APROVADOS no formato de importa√ß√£o do sistema Wehandle (XLSX)</div><div class="form-group"><label class="required">Contrato</label><select id="whContrato"><option value="todos">Todos os Contratos</option>${ctOptions}</select></div><div class="form-group"><label>Data de Admiss√£o (padr√£o p/ quem n√£o tem)</label><input type="date" id="whAdm"></div><div id="whPreview" style="background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:12px;margin:16px 0"><div style="font-size:13px;font-weight:600;margin-bottom:8px">Pr√©via da exporta√ß√£o:</div><div style="font-size:12px;color:#64748b"><div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #e2e8f0"><span>Candidatos Aprovados:</span><strong style="color:#16a34a">${aprovados.length}</strong></div><div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #e2e8f0"><span>Com CPF preenchido:</span><strong style="color:#16a34a">${comCpf.length}</strong></div><div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #e2e8f0"><span>Sem CPF (n√£o exportados):</span><strong style="color:#dc2626">${semCpf.length}</strong></div><div style="display:flex;justify-content:space-between;padding:4px 0"><span>Com dados completos:</span><strong style="color:#2563eb">${completos.length}</strong></div></div></div><div style="background:#fefce8;padding:10px;border-radius:6px;border:1px solid #fde047;margin-bottom:16px;font-size:12px;color:#854d0e">‚ö†Ô∏è Apenas candidatos APROVADOS com CPF preenchido ser√£o exportados.<br>Campos fixos: Nacionalidade=BR, Regime=CLT - Tempo Indeterminado</div><div class="btn-group"><button class="btn btn-wehandle" style="flex:1" id="gerarWehandle">üì§ Gerar XLSX Wehandle</button><button class="btn btn-outline" style="flex:1" id="cancelWh">Cancelar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('cancelWh').onclick=closeModal;
  document.getElementById('gerarWehandle').onclick=function(){gerarXlsxWehandle();};
}

function gerarXlsxWehandle(){
  const ctId=document.getElementById('whContrato').value;
  const admPadrao=document.getElementById('whAdm').value;
  let aprov=candidatos.filter(isOk).filter(c=>c.cpf);
  
  if(ctId!=='todos'){
    const vagasDoContrato=vagas.filter(v=>v.contrato_id===parseInt(ctId)).map(v=>v.id);
    aprov=aprov.filter(c=>vagasDoContrato.includes(c.positionId));
  }
  
  if(!aprov.length){alert('Nenhum candidato aprovado com CPF para exportar!');return;}
  
  // Gerar CSV no layout Wehandle (separador ;)
  let csv='\uFEFF';
  csv+='Identifica√ß√£o Fiscal do Funcion√°rio *;Nome Completo *;Cargo *;Identifica√ß√£o Fiscal da Unidade *;Cbo *;Data de admiss√£o *;Nacionalidade *;Regime de contrato *;Email;Sexo;Data de Nascimento;Sal√°rio;CEP;Endere√ßo;N√∫mero;OBS\n';
  
  aprov.forEach(c=>{
    const v=vagas.find(x=>x.id===c.positionId);
    const ct=getContrato(v);
    const adm=c.data_admissao||admPadrao||'';
    const admFmt=adm?new Date(adm+'T12:00:00').toLocaleDateString('pt-BR'):'';
    const nascFmt=c.data_nascimento?new Date(c.data_nascimento+'T12:00:00').toLocaleDateString('pt-BR'):'';
    
    csv+=`${c.cpf};${c.name};${(v?.title||'').toUpperCase()};${ct?.cnpj||''};${v?.cbo||''};${admFmt};BR;CLT - Tempo Indeterminado;${c.email||''};${c.sexo||''};${nascFmt};${v?.salario||''};${c.cep||''};${c.endereco||''};${c.numero_endereco||''};${c.obs||''}\n`;
  });
  
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download=`WEHANDLE_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  showToast(`üì§ Wehandle exportado! ${aprov.length} candidatos`);
  closeModal();
}

/* ===== EXPORT EXCEL ===== */
function expExcel(){
  let d=candidatos.map(c=>{const v=vagas.find(x=>x.id===c.positionId),ct=getContrato(v);return{n:c.name,f:v?.title||'N/A',e:ETAPAS[c.currentStage]||'N/A',s:v?.state||'',ct:ct?.nome||'N/A',ctId:v?.contrato_id,st:isOk(c)?'Conclu√≠do':'Processo'};});
  d=d.filter(x=>x.n.toLowerCase().includes(filterSearch.toLowerCase())&&(filterContratos.length===0||filterContratos.includes(x.ctId))&&(filterEstado==='todos'||x.s===filterEstado)&&(filterFuncao==='todos'||x.f===filterFuncao));
  d.sort((a,b)=>a.n.localeCompare(b.n));
  let csv='\uFEFF'+'Nome;Fun√ß√£o;Etapa;Estado;Contrato;Status\n';d.forEach(x=>{csv+=`${x.n};${x.f};${x.e};${x.s};${x.ct};${x.st}\n`;});
  const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));a.download=`candidatos_${new Date().toISOString().slice(0,10)}.csv`;a.click();showToast('üìä Excel exportado!');
}

function closeModal(){document.getElementById('modal').classList.add('hidden');}
document.getElementById('modal').onclick=function(e){if(e.target===this)closeModal();};

function confirmDelete(tipo,nome,info,onConfirm){
  document.getElementById('modal-title').textContent='‚ö†Ô∏è Confirmar Exclus√£o';
  document.getElementById('modal-content').innerHTML=`<div style="background:#fef2f2;padding:16px;border-radius:8px;margin-bottom:16px;border:1px solid #fecaca"><div style="font-size:14px;color:#dc2626;font-weight:600;margin-bottom:8px">Voc√™ est√° prestes a excluir:</div><div style="font-size:16px;font-weight:700;color:#1e293b">${nome}</div><div style="font-size:13px;color:#64748b;margin-top:4px">${info}</div></div><div style="background:#fefce8;padding:12px;border-radius:8px;margin-bottom:16px;border:1px solid #fde047"><div style="font-size:13px;color:#854d0e">‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!</div></div><div class="btn-group"><button class="btn btn-danger" style="flex:1" id="confirmDelBtn">üóëÔ∏è Sim, Excluir</button><button class="btn btn-outline" style="flex:1" id="cancelDelBtn">Cancelar</button></div>`;
  document.getElementById('modal').classList.remove('hidden');
  document.getElementById('cancelDelBtn').onclick=closeModal;
  document.getElementById('confirmDelBtn').onclick=async function(){closeModal();await onConfirm();};
}

init();
})();
</script>
</body>
</html>
